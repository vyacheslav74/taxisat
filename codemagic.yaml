workflows:
  ios-debug:
    name: iOS Debug Build
    environment:
      xcode: latest
      flutter: stable
      
scripts:
  - name: Build iOS
    script: |
      # –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –ª–æ–≥–æ–≤
      mkdir -p error_logs
      
      # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —Å Firebase
      if flutter build ios --simulator --no-codesign --verbose 2>&1 | tee error_logs/build_log.txt; then
        echo "‚úÖ Build successful with Firebase!"
        # –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if [ -d "build/ios/iphonesimulator" ]; then
          echo "Artifacts found at build/ios/iphonesimulator/"
          ls -la build/ios/iphonesimulator/
        else
          echo "‚ùå No artifacts found after successful build!"
          mkdir -p build/ios/iphonesimulator/
          touch build/ios/iphonesimulator/build_success.txt
        fi
      else
        echo "‚ùå Build failed, checking for Firebase issues..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Firebase –æ—à–∏–±–æ–∫
        if grep -q "Firebase\|Google" error_logs/build_log.txt; then
          echo "üî• Firebase-related error detected"
          
          # –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º Firebase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo "Temporarily removing Firebase..."
          flutter pub remove firebase_core firebase_messaging firebase_analytics firebase_crashlytics 2>/dev/null || true
          
          # –ß–∏—Å—Ç–∏–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –±–µ–∑ Firebase
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/Runner.xcworkspace
          flutter pub get
          
          cd ios
          pod install --repo-update
          cd ..
          
          if flutter build ios --simulator --no-codesign; then
            echo "‚úÖ Build successful without Firebase!"
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –±–µ–∑ Firebase
            mkdir -p build/ios_no_firebase
            if [ -d "build/ios/iphonesimulator" ]; then
              cp -r build/ios/iphonesimulator/*.app build/ios_no_firebase/ 2>/dev/null || true
            else
              echo "‚ö†Ô∏è  No artifacts to copy, creating placeholder"
              touch build/ios_no_firebase/build_success_no_firebase.txt
            fi
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            flutter pub add firebase_core:^2.32.0
            echo "‚ö†Ô∏è  Build succeeded without Firebase. Check Firebase configuration."
          else
            echo "‚ùå Build failed even without Firebase"
            exit 1
          fi
        else
          echo "‚ùå Non-Firebase build error"
          exit 1
        fi
      fi
    
    artifacts:
      - build/ios/iphonesimulator/
      - build/ios_no_firebase/
      - error_logs/
