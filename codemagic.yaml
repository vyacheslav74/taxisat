workflows:
  ios-debug:
    name: iOS Debug Build
    environment:
      xcode: latest
      flutter: stable
      cocoapods: default
    
    scripts:
      - name: Clean temporary directories
        script: |
          echo "=== Cleaning temp directories ==="
          rm -rf /tmp/flutter_*
          rm -rf /var/folders/*/T/flutter_tools.*
          rm -rf "$HOME/Library/Developer/Xcode/DerivedData/*"
          
          # –°–æ–∑–¥–∞–π—Ç–µ —á–∏—Å—Ç—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥
          export TMPDIR="$HOME/tmp_build"
          mkdir -p "$TMPDIR"
    
      - name: Install flutterfire CLI
        script: |
          echo "Installing flutterfire CLI..."
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          flutterfire --version
          
      - name: Setup project
        script: |
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/Runner.xcworkspace
          flutter pub get
          
      - name: Install pods
        script: |
          cd ios
          pod install --repo-update --verbose
          cd ..
          
      - name: Build iOS
        script: |
          # –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –ª–æ–≥–æ–≤
          mkdir -p error_logs
          
          # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
          if flutter build ios --simulator --no-codesign --verbose 2>&1 | tee error_logs/build_log.txt; then
            echo "‚úÖ Build successful!"
            exit 0
          else
            echo "‚ùå Build failed, checking for Firebase issues..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Firebase –æ—à–∏–±–æ–∫
            if grep -q "Firebase\|Google" error_logs/build_log.txt; then
              echo "üî• Firebase-related error detected"
              
              # –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º Firebase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
              echo "Temporarily removing Firebase..."
              flutter pub remove firebase_core firebase_messaging firebase_analytics firebase_crashlytics 2>/dev/null || true
              
              # –ß–∏—Å—Ç–∏–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –±–µ–∑ Firebase
              flutter clean
              flutter pub get
              
              cd ios
              pod install --repo-update
              cd ..
              
              if flutter build ios --simulator --no-codesign; then
                echo "‚úÖ Build successful without Firebase!"
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                flutter pub add firebase_core:^2.32.0
                exit 0
              else
                echo "‚ùå Build failed even without Firebase"
                exit 1
              fi
            else
              echo "‚ùå Non-Firebase build error"
              exit 1
            fi
          fi
    
    artifacts:
      - build/ios/iphonesimulator/*.app

