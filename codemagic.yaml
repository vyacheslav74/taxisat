workflows:
  ios-debug:
    name: iOS Debug Build
    environment:
      xcode: latest
      flutter: stable
      cocoapods: default
    
    scripts:
      - name: Clean temporary directories
        script: |
          echo "=== Cleaning temp directories ==="
          rm -rf /tmp/flutter_*
          rm -rf /var/folders/*/T/flutter_tools.*
          rm -rf "$HOME/Library/Developer/Xcode/DerivedData/*"
          
          # –°–æ–∑–¥–∞–π—Ç–µ —á–∏—Å—Ç—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥
          export TMPDIR="$HOME/tmp_build"
          mkdir -p "$TMPDIR"
    
      - name: Install flutterfire CLI
        script: |
          echo "Installing flutterfire CLI..."
          dart pub global activate flutterfire_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          flutterfire --version
          
      - name: Setup project
        script: |
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/Runner.xcworkspace
          flutter pub get
          
      - name: Install pods
        script: |
          cd ios
          pod install --repo-update --verbose
          cd ..
          
      - name: Build iOS
    script: |
      # –°–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –ª–æ–≥–æ–≤
      mkdir -p error_logs
      
      # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç —Å Firebase
      if flutter build ios --simulator --no-codesign --verbose 2>&1 | tee error_logs/build_log.txt; then
        echo "‚úÖ Build successful with Firebase!"
        exit 0
      else
        echo "‚ùå Build failed, checking for Firebase issues..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Firebase –æ—à–∏–±–æ–∫
        if grep -q "Firebase\|Google" error_logs/build_log.txt; then
          echo "üî• Firebase-related error detected"
          
          # –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º Firebase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          echo "Temporarily removing Firebase..."
          flutter pub remove firebase_core firebase_messaging firebase_analytics firebase_crashlytics 2>/dev/null || true
          
          # –ß–∏—Å—Ç–∏–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ –±–µ–∑ Firebase
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/Runner.xcworkspace
          flutter pub get
          
          cd ios
          pod install --repo-update
          cd ..
          
          if flutter build ios --simulator --no-codesign; then
            echo "‚úÖ Build successful without Firebase!"
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –±–µ–∑ Firebase
            mkdir -p build/ios_no_firebase
            cp -r build/ios/iphonesimulator/*.app build/ios_no_firebase/
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–æ –ù–ï –≤—ã—Ö–æ–¥–∏–º —Å—Ä–∞–∑—É
            flutter pub add firebase_core:^2.32.0
            echo "‚ö†Ô∏è  Build succeeded without Firebase. Check Firebase configuration."
            exit 0
          else
            echo "‚ùå Build failed even without Firebase"
            exit 1
          fi
        else
          echo "‚ùå Non-Firebase build error"
          exit 1
        fi
      fi
    
    artifacts:
      - build/ios/iphonesimulator/*.app
      - build/ios_no_firebase/*.app  # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –±–µ–∑ Firebase
      - error_logs/
–£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏:
yaml
scripts:
  - name: Build iOS
    script: |
      set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
      mkdir -p logs
      
      # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏
      build_project() {
        echo "=== Building attempt $1 ==="
        flutter clean
        rm -rf ios/Pods ios/Podfile.lock ios/Runner.xcworkspace
        flutter pub get
        
        cd ios
        pod install --repo-update --verbose
        cd ..
        
        flutter build ios --simulator --no-codesign --verbose 2>&1 | tee logs/build_attempt_$1.log
        return ${PIPESTATUS[0]}
      }
      
      # –ü–æ–ø—ã—Ç–∫–∞ 1: –°–±–æ—Ä–∫–∞ —Å Firebase
      if build_project 1; then
        echo "‚úÖ Build successful with all dependencies!"
        exit 0
      fi
      
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏ Firebase
      if grep -q "Firebase\|Google" logs/build_attempt_1.log; then
        echo "üî• Firebase error detected, trying without Firebase..."
        
        # –£–¥–∞–ª—è–µ–º Firebase
        flutter pub remove firebase_core firebase_messaging firebase_analytics firebase_crashlytics 2>/dev/null || true
        
        # –ü–æ–ø—ã—Ç–∫–∞ 2: –ë–µ–∑ Firebase
        if build_project 2; then
          echo "‚úÖ Build successful without Firebase!"
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
          mkdir -p build/without_firebase
          cp -r build/ios/iphonesimulator/*.app build/without_firebase/
          
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Firebase –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
          flutter pub add firebase_core:^2.32.0
          
          # –í—Å–µ —Ä–∞–≤–Ω–æ –≤—ã—Ö–æ–¥–∏–º —Å —É—Å–ø–µ—Ö–æ–º, —Ç–∞–∫ –∫–∞–∫ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞
          exit 0
        else
          echo "‚ùå Build failed even without Firebase"
          exit 1
        fi
      else
        echo "‚ùå Non-Firebase build error"
        exit 1
      fi
    
    artifacts:
      - build/ios/iphonesimulator/*.app
      - build/without_firebase/*.app
      - logs/
–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –í—Å–µ–≥–¥–∞ —Å–æ–±–∏—Ä–∞—Ç—å, –Ω–æ —Å —Ä–∞–∑–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
yaml
scripts:
  - name: Build with Firebase
    script: |
      # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å —Å Firebase
      if flutter build ios --simulator --no-codesign; then
        echo "‚úÖ Firebase build successful"
        mkdir -p build/with_firebase
        cp -r build/ios/iphonesimulator/*.app build/with_firebase/
      else
        echo "‚ö†Ô∏è  Firebase build failed, trying without..."
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ Firebase
      fi
    
  - name: Build without Firebase
    script: |
      # –£–¥–∞–ª—è–µ–º Firebase –∏ —Å–æ–±–∏—Ä–∞–µ–º
      flutter pub remove firebase_core firebase_messaging firebase_analytics firebase_crashlytics 2>/dev/null || true
      flutter clean
      flutter pub get
      
      cd ios
      pod install
      cd ..
      
      if flutter build ios --simulator --no-codesign; then
        echo "‚úÖ Build successful without Firebase"
        mkdir -p build/without_firebase
        cp -r build/ios/iphonesimulator/*.app build/without_firebase/
      else
        echo "‚ùå Build failed completely"
        exit 1
      fi
    
    artifacts:
      - build/with_firebase/*.app
      - build/without_firebase/*.app

