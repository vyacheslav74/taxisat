workflows:
  ios-simulator:
    name: iOS Simulator Build
    environment:
      # УБРАТЬ ios_signing полностью для симулятора
      vars:
        XCODE_WORKSPACE: "Rider.xcworkspace"
        XCODE_SCHEME: "Rider"
        SIMULATOR_DEVICE: "iPhone 15 Pro"
        SIMULATOR_OS: "iOS 17.2"
    
    scripts:
      - name: Install dependencies
        script: npm install
      
      - name: Install pods
        script: |
          cd ios
          pod install
          cd ..
      
      - name: Build for simulator
        script: |
          xcodebuild build \
            -workspace "ios/$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE,OS=$SIMULATOR_OS" \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=YES
      
      - name: Find and archive .app file
        script: |
          APP_PATH=$(find ios/build -name "*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -type d | head -n 1)
          fi
          
          if [ -n "$APP_PATH" ]; then
            echo "Found app at: $APP_PATH"
            mkdir -p build_output
            cp -R "$APP_PATH" build_output/
            zip -r "build_output/Rider-simulator.app.zip" "build_output/Rider.app"
          else
            echo "Error: .app file not found"
            exit 1
          fi
    
    artifacts:
      - build_output/*.zip
      - build_output/*.app
